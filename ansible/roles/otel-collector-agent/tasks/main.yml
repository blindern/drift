- name: Ensure otel-collector-agent directories exist
  file:
    path: "{{ item }}"
    state: directory
    owner: root
    group: root
    mode: 0755
  loop:
    - /var/ansible/otel-collector-agent
    - /var/ansible/otel-collector-agent/state
    - /var/ansible/otel-collector-agent/config.d

- name: Copy otel-collector-agent config
  copy:
    dest: /var/ansible/otel-collector-agent/config.yaml
    src: config.yaml
    owner: root
    group: root
    mode: 0644
  register: config_copied

- name: Get current otel-collector-agent image info
  docker_image_info:
    name: "{{ otel_collector_agent_image }}"
  register: otel_collector_agent_image_before

- name: Pull otel-collector-agent image
  docker_image:
    name: "{{ otel_collector_agent_image }}"
    source: pull
  register: otel_collector_agent_image_pull
  changed_when: >-
    otel_collector_agent_image_before.images | length == 0 or
    otel_collector_agent_image_before.images[0].Id != otel_collector_agent_image_pull.image.Id

- name: Get systemd-journal group ID
  getent:
    database: group
    key: systemd-journal
  register: systemd_journal_group

- name: Start otel-collector-agent container
  docker_container:
    name: otel-collector-agent
    state: started
    image: "{{ otel_collector_agent_image }}"
    restart_policy: unless-stopped
    network_mode: host
    entrypoint:
      - sh
      - -c
      - >-
        exec /otelcol-contrib
        --config=/etc/otelcol-contrib/config.yaml
        $(for f in /etc/otelcol-contrib/config.d/*.yaml; do [ -f "$f" ] && echo "--config=$f"; done)
    groups:
      - "{{ systemd_journal_group.ansible_facts.getent_group['systemd-journal'][1] }}"
    security_opts:
      - label=type:spc_t
    volumes:
      - /var/ansible/otel-collector-agent/config.yaml:/etc/otelcol-contrib/config.yaml:Z
      - /var/ansible/otel-collector-agent/config.d:/etc/otelcol-contrib/config.d:Z
      - /var/ansible/otel-collector-agent/state:/var/otel/state:Z
      - /:/hostfs:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /var/log/journal:/var/log/journal:ro
      - /etc/machine-id:/etc/machine-id:ro
    log_driver: journald
    restart: "{{ config_copied.changed }}"
