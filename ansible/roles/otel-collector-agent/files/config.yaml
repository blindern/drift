receivers:
  hostmetrics:
    root_path: /hostfs
    collection_interval: 60s
    scrapers:
      cpu:
      memory:
      disk:
      filesystem:
        include_mount_points:
          mount_points: [/var/mnt/data, /etc]
          match_type: strict
        metrics:
          system.filesystem.utilization:
            enabled: true
      network:
      load:
      paging:
  docker_stats:
    collection_interval: 60s
  journald:
    directory: /var/log/journal
    storage: file_storage
    convert_message_bytes: true

processors:
  resourcedetection:
    detectors: [env, system]
    system:
      hostname_sources: [os]
  groupbyattrs/service:
    keys: [service.name]
  batch:
  transform/journald:
    error_mode: ignore
    log_statements:
      - context: log
        statements:
          # Preserve raw journald fields before transformation
          - set(attributes["journald.raw"], body)

          # Map PRIORITY to OpenTelemetry severity (non-container logs only)
          # https://www.freedesktop.org/software/systemd/man/latest/systemd.journal-fields.html
          - set(severity_number, SEVERITY_NUMBER_DEBUG) where body["CONTAINER_NAME"] == nil and Int(body["PRIORITY"]) == 7
          - set(severity_number, SEVERITY_NUMBER_INFO) where body["CONTAINER_NAME"] == nil and Int(body["PRIORITY"]) == 6
          - set(severity_number, SEVERITY_NUMBER_INFO2) where body["CONTAINER_NAME"] == nil and Int(body["PRIORITY"]) == 5
          - set(severity_number, SEVERITY_NUMBER_WARN) where body["CONTAINER_NAME"] == nil and Int(body["PRIORITY"]) == 4
          - set(severity_number, SEVERITY_NUMBER_ERROR) where body["CONTAINER_NAME"] == nil and Int(body["PRIORITY"]) == 3
          - set(severity_number, SEVERITY_NUMBER_FATAL) where body["CONTAINER_NAME"] == nil and Int(body["PRIORITY"]) <= 2

          # Container-specific fields
          - set(attributes["container.name"], body["CONTAINER_NAME"]) where body["CONTAINER_NAME"] != nil
          - set(attributes["container.id"], body["CONTAINER_ID"]) where body["CONTAINER_ID"] != nil
          - set(attributes["container.image.name"], body["IMAGE_NAME"]) where body["IMAGE_NAME"] != nil

          # Set service.name: container name for Docker, syslog identifier for systemd, fallback to unknown
          # Set as regular attribute first; groupbyattrs processor promotes it to resource attribute
          - set(attributes["service.name"], "unknown")
          - set(attributes["service.name"], body["SYSLOG_IDENTIFIER"]) where body["SYSLOG_IDENTIFIER"] != nil
          - set(attributes["service.name"], body["CONTAINER_NAME"]) where body["CONTAINER_NAME"] != nil

          # Process info (semantic conventions)
          - set(attributes["process.command"], body["_COMM"]) where body["_COMM"] != nil
          - set(attributes["process.executable.path"], body["_EXE"]) where body["_EXE"] != nil
          - set(attributes["process.pid"], body["_PID"]) where body["_PID"] != nil
          - set(attributes["process.user.id"], body["_UID"]) where body["_UID"] != nil
          - set(attributes["process.group.id"], body["_GID"]) where body["_GID"] != nil

          # Systemd fields
          - set(attributes["systemd.unit"], body["_SYSTEMD_UNIT"]) where body["_SYSTEMD_UNIT"] != nil
          - set(attributes["syslog.identifier"], body["SYSLOG_IDENTIFIER"]) where body["SYSLOG_IDENTIFIER"] != nil
          - set(attributes["syslog.priority"], body["PRIORITY"]) where body["PRIORITY"] != nil
          - set(attributes["log.transport"], body["_TRANSPORT"]) where body["_TRANSPORT"] != nil

          # Set body to just the message
          - set(body, body["MESSAGE"])

extensions:
  health_check: {}
  file_storage:
    directory: /var/otel/state

exporters:
  otlp:
    endpoint: signoz-otel-collector.zt.foreningenbs.no:4317
    tls:
      insecure: true

service:
  extensions: [health_check, file_storage]
  pipelines:
    metrics:
      receivers: [hostmetrics, docker_stats]
      processors: [resourcedetection, batch]
      exporters: [otlp]
    logs:
      receivers: [journald]
      processors: [transform/journald, groupbyattrs/service, resourcedetection, batch]
      exporters: [otlp]
