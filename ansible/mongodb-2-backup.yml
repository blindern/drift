- hosts: fcos-2
  become: yes
  gather_facts: no
  tasks:
    - name: Set backup filename
      set_fact:
        backup_file: "/var/mnt/data/mongodb-2-backup-{{ now(utc=true, fmt='%Y%m%dT%H%M%SZ') }}.archive.xz"

    - name: Create MongoDB backup (mongodump)
      shell: >
        docker exec mongodb-2 mongodump --archive
        --uri='{{ lookup('file', playbook_dir + '/../mongodb-uri.txt') | trim | replace('mongodb-2.zt.foreningenbs.no', 'localhost') }}'
        | xz > {{ backup_file }}

    - name: Verify backup file is non-empty
      stat:
        path: "{{ backup_file }}"
      register: backup_stat
      failed_when: not backup_stat.stat.exists or backup_stat.stat.size < 100

    - name: Show backup info
      debug:
        msg: "Backup created: {{ backup_file }} ({{ backup_stat.stat.size }} bytes)"
