- hosts: fcos-1
  become: yes
  gather_facts: no
  tasks:
    - name: Set backup filename
      set_fact:
        backup_file: "/var/mnt/data/uka-mysql-backup-{{ now(utc=true, fmt='%Y%m%dT%H%M%SZ') }}.sql.xz"

    - name: Copy credentials to host
      copy:
        src: "{{ playbook_dir }}/../mysql-uka.cnf"
        dest: /tmp/ansible-mysqldump-uka-mysql.cnf
        mode: "0600"

    - name: Copy credentials into container
      command: docker cp /tmp/ansible-mysqldump-uka-mysql.cnf uka-mysql:/tmp/ansible-mysqldump-uka-mysql.cnf

    - name: Remove credentials from host
      file:
        path: /tmp/ansible-mysqldump-uka-mysql.cnf
        state: absent

    - name: Create MySQL backup (mysqldump)
      shell: "docker exec uka-mysql mysqldump --defaults-extra-file=/tmp/ansible-mysqldump-uka-mysql.cnf --all-databases --single-transaction | xz > {{ backup_file }}"

    - name: Remove credentials from container
      command: docker exec uka-mysql rm /tmp/ansible-mysqldump-uka-mysql.cnf

    - name: Verify backup file is non-empty
      stat:
        path: "{{ backup_file }}"
      register: backup_stat
      failed_when: not backup_stat.stat.exists or backup_stat.stat.size < 100

    - name: Show backup info
      debug:
        msg: "Backup created: {{ backup_file }} ({{ backup_stat.stat.size }} bytes)"
